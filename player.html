<!--
╔══════════════════════════════════════════════════════════════════════════════╗
║                     Korean Live TV Streaming Player                          ║
║                                                                              ║
║  Description: A high-performance HTML5 streaming player for Korean TV       ║
║               channels using HLS (HTTP Live Streaming) technology           ║
║                                                                              ║
║  Features:                                                                   ║
║    • 70+ Korean TV channels (News, Sports, Entertainment, Kids, etc.)       ║
║    • EPG (Electronic Program Guide) tooltips with NOW/NEXT info             ║
║    • Pure CSS channel buttons (no external image dependencies)              ║
║    • Optimized rendering with DocumentFragment                              ║
║    • Search functionality to filter channels                                ║
║    • Channel categories for easy navigation                                 ║
║    • Error handling and loading states                                      ║
║    • Responsive design for mobile and desktop                               ║
║    • HLS.js integration with fallback for native HLS support               ║
║                                                                              ║
║  Technology Stack:                                                           ║
║    • HLS.js - HTTP Live Streaming library                                   ║
║    • Vanilla JavaScript - No framework dependencies                         ║
║    • CSS3 - Modern styling with Grid and Flexbox                            ║
║                                                                              ║
║  Browser Support:                                                            ║
║    • Chrome, Firefox, Edge: Uses HLS.js                                     ║
║    • Safari, iOS: Native HLS support                                        ║
║                                                                              ║
║  Version: 2.1                                                                ║
║  Last Updated: 2025-10-04                                                    ║
╚══════════════════════════════════════════════════════════════════════════════╝
-->
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Watch Korean Live TV channels online - Free HLS streaming player">
    <meta name="keywords" content="Korean TV, Live Stream, KBS, MBC, SBS, tvN, JTBC">
    <title>韩国电视直播 - Korean Live TV Streaming</title>

    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>📺</text></svg>">

    <!-- HLS.js library for HTTP Live Streaming support -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

    <!-- pako.js library for gzip decompression (Phase 2.5: Live XMLTV) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>

    <style>
        /* ===== GLOBAL STYLES ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        /* ===== VIDEO PLAYER SECTION ===== */
        #video-container {
            width: 100%;
            background-color: #000;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            position: relative;
        }

        video {
            width: 100%;
            height: 70vh;
            max-height: 600px;
            background-color: #000;
            display: block;
        }

        /* Loading indicator for video */
        #loading-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #fff;
            font-size: 18px;
            display: none;
            z-index: 10;
        }

        #loading-indicator.active {
            display: block;
        }

        /* Current channel info display */
        #current-channel {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: #fff;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            z-index: 10;
        }

        /* ===== CONTROLS SECTION ===== */
        #controls-container {
            background: #fff;
            padding: 20px;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        }

        #search-container {
            max-width: 600px;
            margin: 0 auto 20px;
        }

        #search-input {
            width: 100%;
            padding: 12px 20px;
            font-size: 16px;
            border: 2px solid #ddd;
            border-radius: 25px;
            outline: none;
            transition: border-color 0.3s;
        }

        #search-input:focus {
            border-color: #667eea;
        }

        /* Category filter buttons */
        #category-filter {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .category-btn {
            padding: 8px 16px;
            border: 2px solid #667eea;
            background: #fff;
            color: #667eea;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .category-btn:hover,
        .category-btn.active {
            background: #667eea;
            color: #fff;
        }

        /* ===== CHANNEL GRID ===== */
        #channel-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 15px;
            padding: 20px;
            background: #f8f9fa;
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Channel button styling - Pure CSS, no external images */
        .channel-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            border: none;
            border-radius: 12px;
            padding: 20px 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            text-align: center;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            word-wrap: break-word;
            position: relative;
            overflow: visible; /* Changed from hidden to visible for EPG tooltip */
        }

        .channel-btn::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.2) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.3s;
            border-radius: 12px; /* Match button border-radius to contain effect */
        }

        .channel-btn:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25);
        }

        .channel-btn:hover::before {
            opacity: 1;
        }

        .channel-btn:active {
            transform: translateY(-1px) scale(1.02);
        }

        /* Active/playing channel style */
        .channel-btn.playing {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            box-shadow: 0 6px 20px rgba(245, 87, 108, 0.4);
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        /* Hidden channel (for search/filter) */
        .channel-btn.hidden {
            display: none;
        }

        /* Category-specific colors */
        .channel-btn[data-category="news"] {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }

        .channel-btn[data-category="sports"] {
            background: linear-gradient(135deg, #30cfd0 0%, #330867 100%);
        }

        .channel-btn[data-category="entertainment"] {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
        }

        .channel-btn[data-category="kids"] {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
        }

        /* ===== RESPONSIVE DESIGN ===== */
        @media (max-width: 768px) {
            video {
                height: 50vh;
            }

            #channel-grid {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
                gap: 10px;
                padding: 10px;
            }

            .channel-btn {
                padding: 15px 5px;
                font-size: 12px;
                min-height: 60px;
            }

            #current-channel {
                font-size: 14px;
                padding: 8px 15px;
            }

            .category-btn {
                font-size: 12px;
                padding: 6px 12px;
            }
        }

        /* ===== ERROR MESSAGE ===== */
        #error-message {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #f44336;
            color: #fff;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            display: none;
            z-index: 1000;
            max-width: 300px;
        }

        #error-message.show {
            display: block;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* ===== EPG TOOLTIP STYLES ===== */
        .epg-tooltip {
            position: absolute;
            bottom: 110%;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.98) 0%, rgba(118, 75, 162, 0.98) 100%);
            color: #fff;
            padding: 16px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            min-width: 280px;
            max-width: 320px;
            z-index: 1000;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease, transform 0.3s ease;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .epg-tooltip::before {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-top: 8px solid rgba(118, 75, 162, 0.98);
        }

        .channel-btn:hover .epg-tooltip {
            opacity: 1;
            transform: translateX(-50%) translateY(-5px);
        }

        .epg-tooltip h4 {
            margin: 0 0 12px 0;
            font-size: 16px;
            font-weight: 700;
            border-bottom: 2px solid rgba(255, 255, 255, 0.3);
            padding-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .epg-tooltip h4::before {
            content: '📺';
            font-size: 18px;
        }

        .epg-program {
            margin-bottom: 10px;
            padding: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            border-left: 3px solid #fee140;
        }

        .epg-program:last-child {
            margin-bottom: 0;
            border-left-color: #a8edea;
        }

        .epg-time {
            font-size: 11px;
            font-weight: 600;
            color: #fee140;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .epg-time::before {
            content: '🕒';
            font-size: 12px;
        }

        .epg-title {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 3px;
            line-height: 1.3;
        }

        .epg-desc {
            font-size: 11px;
            opacity: 0.9;
            line-height: 1.4;
        }

        .epg-badge {
            display: inline-block;
            background: rgba(254, 225, 64, 0.3);
            color: #fee140;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 700;
            margin-left: 6px;
        }

        .epg-no-data {
            text-align: center;
            padding: 12px;
            font-size: 13px;
            opacity: 0.8;
            font-style: italic;
        }
    </style>
</head>
<body>
    <!-- Video Player Section -->
    <div id="video-container">
        <video id="video" controls></video>
        <div id="loading-indicator">Loading stream...</div>
        <div id="current-channel">Select a channel</div>
    </div>

    <!-- Error Message Display -->
    <div id="error-message"></div>

    <!-- Controls and Channel Selection -->
    <div id="controls-container">
        <!-- Search Bar -->
        <div id="search-container">
            <input
                type="text"
                id="search-input"
                placeholder="🔍 搜索频道... / Search channels..."
                aria-label="Search channels"
            >
        </div>

        <!-- Category Filters -->
        <div id="category-filter">
            <button class="category-btn active" data-category="all">全部 All</button>
            <button class="category-btn" data-category="major">主流 Major</button>
            <button class="category-btn" data-category="news">新闻 News</button>
            <button class="category-btn" data-category="sports">体育 Sports</button>
            <button class="category-btn" data-category="entertainment">娱乐 Entertainment</button>
            <button class="category-btn" data-category="kids">儿童 Kids</button>
        </div>

        <!-- Channel Grid -->
        <div id="channel-grid"></div>
    </div>

    <script>
        // ===== CONFIGURATION AND INITIALIZATION =====

        const video = document.getElementById('video');
        const channelGrid = document.getElementById('channel-grid');
        const searchInput = document.getElementById('search-input');
        const currentChannelDisplay = document.getElementById('current-channel');
        const loadingIndicator = document.getElementById('loading-indicator');
        const errorMessage = document.getElementById('error-message');
        const categoryBtns = document.querySelectorAll('.category-btn');

        let hls = null;
        let currentChannel = null;

        // ===== CHANNEL DATA =====
        // Each channel has: name, url (M3U8 stream), and category
        const channels = [
            // Major Broadcasters
            { name: "KBS1", url: "https://live-edge-th136.myjktv.com:443/watch/live.m3u8?video=kbs1_540&sid=fyAvvD3F74POZh6GmE2btRtXE3FRA7x4WA5l1B5m&secret=f1ecf5d3c1cda86dc1eb741cec2e91bf&time=1742499426", category: "major" },
            { name: "KBS2", url: "https://live-edge-th136.myjktv.com:443/watch/live.m3u8?video=kbs2_540&sid=nGwIH0XSiD8i6BgNlw1BzsZ9ZkNGavHRb7KWRaUB&secret=24378334b2628dc756899977221fbe37&time=1742499579", category: "major" },
            { name: "MBC", url: "https://live-edge-th136.myjktv.com:443/watch/live.m3u8?video=mbc_540&sid=OiF7QW8tv67KzSp46AumV3RRfFzaM23xbWGWK1EE&secret=52841b1a2fc1ea3572f35742831c2823&time=1746640316", category: "major" },
            { name: "SBS", url: "https://live-edge-th136.myjktv.com:443/watch/live.m3u8?video=sbs_540&sid=pgl0MLCBpuhYsXqyNXvAxTpnwsO7Z0LIv6TjzgW7&secret=3890d3e89e3ba3c4fe9c7bf7e93b7db1&time=1746640387", category: "major" },
            { name: "EBS1", url: "https://live-edge-th136.myjktv.com:443/watch/live.m3u8?video=ebs_1_540&sid=hYnLduDv8nt54u8V33fzOzX2965Hpw5riMGhlJ3R&secret=49acbb73b9d018958342b304a2c5c7f4&time=1742556411", category: "major" },
            { name: "EBS2", url: "https://live-edge-th136.myjktv.com:443/watch/live.m3u8?video=ebs_2_540&sid=0wonnSSHsGui3yCUVS2h68L4nXKpocbek6UATVNu&secret=b6c54f84829101b5d1159e0143a063e1&time=1742556563", category: "major" },

            // Entertainment Channels
            { name: "tvN", url: "http://warlock0.synology.me:9999/klive/api/url.m3u8?m=url&s=tving&i=C00551&q=FHD&apikey=5MY50EII66", category: "entertainment" },
            { name: "JTBC", url: "https://live-edge-th136.myjktv.com:443/watch/live.m3u8?video=jtbc_540&sid=ueRIPcU1CmpLxvesJU3p3VVgAfWDA7Gq6Ok1SwdS&secret=7e0fd7ca14ec47bd96aca368dade12a4&time=1742499897", category: "entertainment" },
            { name: "JTBC3", url: "https://live-edge-th136.myjktv.com:443/watch/live.m3u8?video=jtbc_3_540&sid=Apn7LTiUje3L7FmQObTgYnKBNeDUDytdiUSkqYw1&secret=7e6facc78d8f68a85388b1945d966a04&time=1742501522", category: "entertainment" },
            { name: "OCN", url: "https://live-edge-th136.myjktv.com:443/watch/live.m3u8?video=ocn_540&sid=PrqoQCvTSMHCbYJxID74xAc3NKuScy5PRuM1xirg&secret=562fb04d97cad7f46e7b55f63214df25&time=1747425397", category: "entertainment" },
            { name: "OCN Movies", url: "https://live-edge-th136.myjktv.com:443/watch/live.m3u8?video=cgv_540&sid=ITjFbSesTCA6lhGQOkb3FkEBcBDIkkRJMIxUQdCp&secret=5d308748415770c93f1f9f0c0ed6e8b6&time=1747425455", category: "entertainment" },
            { name: "OCN Movies2", url: "https://live-edge-th136.myjktv.com:443/watch/live.m3u8?video=super_action_540&sid=QPacI6i2eH4RJ3EUx6gV4cCyzBRIBmJJyITwSCrN&secret=20e95b15862eb7628d7e1db6ef6dff2d&time=1742502255", category: "entertainment" },
            { name: "CJ ENM Movie", url: "https://jmp2.uk/stvp-KRBC32000191N", category: "entertainment" },
            { name: "PLAYY", url: "https://jmp2.uk/stvp-KR12000017G", category: "entertainment" },
            { name: "MNet", url: "http://warlock0.synology.me:9999/klive/api/url.m3u8?m=url&s=tving&i=C00579&q=FHD&apikey=5MY50EII66", category: "entertainment" },
            { name: "tvN Show", url: "http://warlock0.synology.me:9999/klive/api/url.m3u8?m=url&s=tving&i=C01141&q=FHD&apikey=5MY50EII66", category: "entertainment" },
            { name: "tvN STORY", url: "https://jmp2.uk/stvp-KRBC3200014XZ", category: "entertainment" },
            { name: "tvN DRAMA", url: "http://warlock0.synology.me:9999/klive/api/url.m3u8?m=url&s=tving&i=C01143&q=FHD&apikey=5MY50EII66", category: "entertainment" },
            { name: "ENA", url: "https://live-edge-th136.myjktv.com:443/watch/live.m3u8?video=kbs_joy_540&sid=tLqu4O06OBUd42Bf6pQzEj5iFGeblET7JuLcQfc7&secret=9b1bada69fe289f71ac1e24e8376b857&time=1742501919", category: "entertainment" },
            { name: "MBC every1", url: "https://tistory1.daumcdn.net/tistory/2864485/skin/images/CATV_223_D2C739D6.m3u8", category: "entertainment" },
            { name: "SBS Plus", url: "https://live-edge-th136.myjktv.com:443/watch/live.m3u8?video=sbs_plus_540&sid=syCIAWw5LA5R9EkVZhUAQgU7aMIoy8ojVwul0T1b&secret=406c160188ee60dacd0829b4d801fc2e&time=1742560026", category: "entertainment" },
            { name: "Channel E", url: "https://live-edge-th136.myjktv.com:443/watch/live.m3u8?video=channel_e_540&sid=y8c3beG6YJJDp9UMDq1kKSrl1NC0wY4mjXGAlZP6&secret=9ae1c63d7157e00c9298122b44e8e081&time=1742560086", category: "entertainment" },
            { name: "KBS Drama", url: "https://live-edge-th136.myjktv.com:443/watch/live.m3u8?video=kbs_drama_540&sid=q3B5WSCH4URY8GiHOmAi4YrNVPWKot9vVlo9Vif3&secret=af52b1a2db7f1a11eee422a86931dfa4&time=1742559860", category: "entertainment" },
            { name: "코메디TV", url: "https://live-edge-th136.myjktv.com:443/watch/live.m3u8?video=comedy_540&sid=VwrbOrArABoCGtqRD7p4O5o3TLyqonOhScABtAo7&secret=2fe9f41d49ae8ea23b419e850b69671d&time=1742501996", category: "entertainment" },
            { name: "MBC On", url: "https://live-edge-th136.myjktv.com:443/watch/live.m3u8?video=mbc_on_540&sid=1n0TiOLYplMhPQUiUnKKf3j1UuULzQWKwPSDBrkt&secret=0a8915eba29dd2179cd38d8f7fb004ba&time=1742502620", category: "entertainment" },

            // News Channels
            { name: "YTN", url: "https://live-edge-th136.myjktv.com:443/watch/live.m3u8?video=ytn_540&sid=HxS8g2O614Z22pnhG5974Hey06SlgSHeT24eUPwD&secret=3d4c2a8304d1673ecd3114c5c6f48568&time=1742500356", category: "news" },
            { name: "뉴스Y", url: "https://live-edge-th136.myjktv.com:443/watch/live.m3u8?video=newsy_540&sid=DzpUFHjcsBWVT59UIekH9Ru1NlsNITdMENCIwOYj&secret=627df873aaaabccbbfacb5cf54826ff2&time=1742500601", category: "news" },
            { name: "CNN", url: "https://live-edge-th136.myjktv.com:443/watch/live.m3u8?video=cnn_kr_540&sid=7ySL8aoIyy2NPbS1ENkvzkgj9C3GvJq2bdQ7PneQ&secret=0477f93d5d7e29a87ad3482bd1ecf100&time=1742558366", category: "news" },
            { name: "BBC", url: "https://live-edge-th136.myjktv.com:443/watch/live.m3u8?video=bbc_kr_540&sid=NvDfJvaZ3zU7NbrHR43AaUgWJK2zdoOc8KCQzTll&secret=aa2b347766700a37e0d86da63886687d&time=1742558446", category: "news" },
            { name: "NHK World", url: "https://live-edge-th136.myjktv.com:443/watch/live.m3u8?video=nhk_wold_540&sid=VQ5jdk6wCPjw6VcPfOv76Syot6CoP9YgzBLFeHjZ&secret=a86dad9133b53ffc834fe98b63c98919&time=1742558568", category: "news" },
            { name: "TV조선", url: "https://live-edge-th136.myjktv.com:443/watch/live.m3u8?video=tvchosun_540&sid=fKZsnPIjdoVZrjIWsqL5dPcQwba75T2ANFPAQIih&secret=18d00e092d1f8fa5a6107f0328ff4972&time=1742500050", category: "news" },
            { name: "채널A", url: "https://live-edge-th136.myjktv.com:443/watch/live.m3u8?video=channela_540&sid=zLhHxUtd4yz2toiohNMEfx63yhemDSOd2xgsFaBV&secret=ad760dc9b77c911e341d5e114e36feff&time=1742500133", category: "news" },
            { name: "MBN", url: "https://live-edge-th136.myjktv.com:443/watch/live.m3u8?video=mbn_540&sid=JrgTsnJKQo0TU9yiyoZf7eA9llHJEMpTQlgyggsJ&secret=68b0e61613ec8fda51fd248052b6aa69&time=1742500229", category: "news" },
            { name: "한국경제", url: "https://live-edge-th136.myjktv.com:443/watch/live.m3u8?video=wowtv_540&sid=78aYN4ktf0r1dt55tnyXZwly6i1geE6psoDdZvce&secret=d1de772e9eeb5dcf1636c239f633cdb2&time=1742500679", category: "news" },

            // Sports Channels
            { name: "tvN Sports", url: "https://live-edge-th136.myjktv.com:443/watch/live.m3u8?video=olivetv_540&sid=8LbyMvKsXavagjD6y1ZNlDZMivTbD8w8Ylaki0aF&secret=4f3264b31cd2376538d9af4207f9be85&time=1745187636", category: "sports" },
            { name: "KBSNSPORTS", url: "https://live-edge-th136.myjktv.com:443/watch/live.m3u8?video=kbs_n_sports_540&sid=2d4lU588IfghL2opd7HM63yE2wS8H52ARHw5HXRQ&secret=2352918e6d64f698127757fa594e1ff4&time=1742500742", category: "sports" },
            { name: "MBC SPORTS", url: "https://live-edge-th136.myjktv.com:443/watch/live.m3u8?video=mbc_sports_540&sid=9bv6hEGMpr1RCdE1DpMiWx2PrX8a8kKE1GMt0dJ6&secret=acef719ee24b555d553a928126e2bbd1&time=1742500830", category: "sports" },
            { name: "SKY SPORTS", url: "https://live-edge-th136.myjktv.com:443/watch/live.m3u8?video=sky_sports_540&sid=izUD3XjpFBIK6xFNQ1BcgBGH5Ldy0HVkyD5UoRSO&secret=63f2413d9711c04b1a825c8e733a5204&time=1756907428", category: "sports" },
            { name: "SBS SPORTS", url: "https://live-edge-th136.myjktv.com:443/watch/live.m3u8?video=sbs_sports_540&sid=XMv6aPlBrU1o23QTwnURWnfHoRT7hOQ8nwH7wK9H&secret=849647c33502f9f8d1a1d67e20719008&time=1742501076", category: "sports" },
            { name: "SBS GOLF", url: "https://live-edge-th136.myjktv.com:443/watch/live.m3u8?video=sbs_golf_540&sid=8No4oKWpRJMbb9rsAuWQ75ACx37sUj3gRkeLupvY&secret=72464b0ac707bb73f4d46a2e1082e64f&time=1748029685", category: "sports" },
            { name: "JTBC GOLF", url: "http://211.110.63.98/jtbcgolf1/_definst_/8C4A78EB4291B2BA8795B9AF907E8A9B28DBF956ADF0AB46A0C5E48207BC8773/chunklist_w1885910863.m3u8", category: "sports" },
            { name: "JTBC GOLF&SPORTS", url: "http://211.110.63.98/jtbc3sports1/_definst_/92EE8BC280FBC3F170429AC55F0234B0E9A288DD1A54804514EA4B2D1D861D79/chunklist_w2059444615.m3u8", category: "sports" },
            { name: "PGA Tour", url: "https://jmp2.uk/stvp-KRBD3100007WB", category: "sports" },
            { name: "스크린골프", url: "https://jmp2.uk/stvp-KR44000010Y", category: "sports" },
            { name: "SPOTV", url: "https://live-edge-th136.myjktv.com:443/watch/live.m3u8?video=spotv_540&sid=w9sTaDbkcNRJ1Op6LvowKsB9qiIwEXaLK6jQmc9a&secret=700a37478a2572879ff8a64e7e43faa9&time=1742501358", category: "sports" },
            { name: "SPOTV2", url: "https://live-edge-th136.myjktv.com:443/watch/live.m3u8?video=spotv_2_540&sid=JCn330xSXpDUtieRguQzRx0q5D2azRNty2G69TqK&secret=a8bf52caed9a7411a14c3dbcaf4f70b4&time=1742501441", category: "sports" },
            { name: "SPOTV Prime", url: "https://live-edge-th136.myjktv.com:443/watch/live.m3u8?video=spotv_prime_540&sid=V1R87ydx8jeZbnselXMKDBx9IPKMXNa5Zv7Iqv31&secret=79ee49d5533da8320bdd61ec92cd4ded&time=1742501589", category: "sports" },
            { name: "SPOTV On", url: "https://live-edge-th136.myjktv.com:443/watch/live.m3u8?video=spotv_on_540&sid=khuvDUGA5oq5SVN9qUTdlNpFKsr85NI7poL0OHU7&secret=4b9ae05ec416ae0275d3cee4511e7f7b&time=1742501659", category: "sports" },
            { name: "BilliardsTV", url: "https://live-edge-th136.myjktv.com:443/watch/live.m3u8?video=billiardstv_540&sid=dhbSSmqXjzcAIi6TV9nwpPQYU97Q5dFXLAFrT4EA&secret=7b49ace0e217934036273cc10a61f817&time=1742501837", category: "sports" },
            { name: "IB SPORTS", url: "https://live-edge-th136.myjktv.com:443/watch/live.m3u8?video=jtbc_3_540&sid=Apn7LTiUje3L7FmQObTgYnKBNeDUDytdiUSkqYw1&secret=7e6facc78d8f68a85388b1945d966a04&time=1742501522", category: "sports" },
            { name: "SKY SPORTS F1", url: "http://fortv.cc:8080/clarencekingrh@hotmail.com/pKgSdl4ZFX/35244", category: "sports" },
            { name: "OGN starleague", url: "https://jmp2.uk/stvp-KRBC3200005SH", category: "sports" },

            // Kids and Educational
            { name: "중화TV", url: "https://live-edge-th136.myjktv.com:443/watch/live.m3u8?video=chinesetv_540&sid=ZhoPSyCssGAH4bZqbgtiLGY2RRNtZkpxdNaqJ59Z&secret=d61b57728a4807c259df2dad974b8d5b&time=1742555489", category: "kids" },
            { name: "바둑TV", url: "https://live-edge-th136.myjktv.com:443/watch/live.m3u8?video=baduk_540&sid=BUdcXyBWIi9dQgC9QbarQyw1r2Punh3ScBDyvPkx&secret=46f15e2f7aa89b944adadb345e1d66af&time=1742555602", category: "kids" },
            { name: "브레인TV", url: "https://live-edge-th136.myjktv.com:443/watch/live.m3u8?video=brain_tv_540&sid=pXLsKDVuSzSlCPzDBtZ3Tjp06jRx0Cjb6hMFnxt4&secret=1f34a19c2968298e793fc294a26ec99c&time=1742555675", category: "kids" },
            { name: "FTV", url: "https://live-edge-th136.myjktv.com:443/watch/live.m3u8?video=ftv_540&sid=bZKhHcxaPkJGE3mmH8UPN66ooPuufcWyGBuvtjTO&secret=5d91e5de24f5cb3123ee6e659939bdb5&time=1742555798", category: "kids" },
            { name: "네셔날지오그래피", url: "https://live-edge-th136.myjktv.com:443/watch/live.m3u8?video=national_540&sid=Frw4dKWvqJLBjvHgByjOVO1M8zkSD6LjvUABHvLS&secret=5c8e0f0753609c3db02f0a5a0786ccd1&time=1742555875", category: "kids" },
            { name: "디스커버리", url: "https://live-edge-th136.myjktv.com:443/watch/live.m3u8?video=discovery_540&sid=2iObz48WCFCkHcuaQTRez5kpeHPfdHYiOE1icCKS&secret=660b5a2059948553effae93e4def6d04&time=1742555991", category: "kids" },
            { name: "Nat Geo Wild", url: "https://live-edge-th136.myjktv.com:443/watch/live.m3u8?video=nat_geo_wild_540&sid=0wJqyjtLKS6wxrUnZ6cnaRHDVz6ztklaA1tOzALv&secret=8a3bcec4a32f89003264607c049a2ce3&time=1742556081", category: "kids" },
            { name: "History", url: "https://live-edge-th136.myjktv.com:443/watch/live.m3u8?video=history_540&sid=ktDYnxAlcjz7V3RTfpIGFtr5pGjLTXXbuEqQQTjG&secret=fa393d7a7f8b5c570fa9a02d67e5ddb8&time=1742556221", category: "kids" },
            { name: "iNET", url: "https://live-edge-th136.myjktv.com:443/watch/live.m3u8?video=inet_540&sid=OPbFOFpoTQ729gz3U05zWdlE920QJze3POZPfHuO&secret=5121ac51f8f56d26f013a0db2cbe06e9&time=1742556350", category: "kids" },
            { name: "JEI 재능TV", url: "https://live-edge-th136.myjktv.com:443/watch/live.m3u8?video=jei_jenung_540&sid=5x1n6FyzRQMkri2LhZ71Mjao59LSpdVKNNnvDkJW&secret=1fd8004ee3d2c119d064ec88b38d97b3&time=1742556811", category: "kids" },
            { name: "육아방송", url: "https://live-edge-th136.myjktv.com:443/watch/live.m3u8?video=child_care_540&sid=MCMbs5pnRCoyIVAPtv5g0MRDu11MEoQNUSSpZfsk&secret=706abe245cd1b8483e082c3ee34c19b3&time=1742556877", category: "kids" },
            { name: "뽀요 TV", url: "https://live-edge-th136.myjktv.com:443/watch/live.m3u8?video=disney_channel_540&sid=f6coDFH9FZGv5Tl9FZinkVetugwWFq3RjSfNJIWl&secret=c0c2de490583ac54b9710cc8ac2a8636&time=1742556938", category: "kids" },
            { name: "KBS kids", url: "https://live-edge-th136.myjktv.com:443/watch/live.m3u8?video=kbs_kids_540&sid=6GIrIVmGxADvFwNcDZn2ZKO972L101Y0O54pvVUu&secret=e5d3211063e265afd0cd9f542d9d3de2&time=1742557009", category: "kids" },
            { name: "Toonivers", url: "https://live-edge-th136.myjktv.com:443/watch/live.m3u8?video=tooniverse_540&sid=eCxHR168RlUUkQqYOIWVyWfIUxPu06nBlSxHIO46&secret=96b99d3a3fdfca5375de61e8c24350b4&time=1742557506", category: "kids" },
            { name: "Cartoon", url: "https://live-edge-th136.myjktv.com:443/watch/live.m3u8?video=cartoon_network_540&sid=RyguKlLteLqv9rk0RS2MXuF7i1rMwPylYuihkE8h&secret=285476c7f0a52c71c066532526326dde&time=1742558094", category: "kids" },
            { name: "어린이TV", url: "https://live-edge-th136.myjktv.com:443/watch/live.m3u8?video=childrens_tv_540&sid=bacS5e2f2oSXK0Jq8h8erviPliIz00vJqZSDx7AV&secret=e37983794947e47b83649a92de60f3da&time=1742558216", category: "kids" },
            { name: "ANIPLUS", url: "http://warlock0.synology.me:9999/klive/api/url.m3u8?m=url&s=tving&i=C00901&q=FHD&apikey=5MY50EII66", category: "kids" },

            // Shopping
            { name: "현대홈쇼핑", url: "https://live-edge-th136.myjktv.com:443/watch/live.m3u8?video=hyundaih_mall_540&sid=kRIZglDoTkTX95OSEfXY5VUZFpfFq6cVReRRuWSR&secret=fb19ea96320fbea13ea32914018bf9af&time=1742560145", category: "entertainment" }
        ];

        // ===== EPG PHASE 2: XMLTV & TIME-BASED MATCHING =====
        // Real-time program matching with LocalStorage caching
        // Supports XMLTV format for future integration

        /**
         * Lightweight XMLTV Parser
         * Parses XMLTV format XML into structured program data
         */
        class XMLTVParser {
            /**
             * Parse XMLTV XML string into program data structure
             * @param {string} xmlString - XMLTV format XML
             * @returns {Object} Parsed data: { channels: Map, programmes: Array }
             */
            static parse(xmlString) {
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlString, 'text/xml');

                // Check for parse errors
                const parseError = xmlDoc.querySelector('parsererror');
                if (parseError) {
                    throw new Error('XML parsing failed: ' + parseError.textContent);
                }

                // Parse channels
                const channels = new Map();
                xmlDoc.querySelectorAll('channel').forEach(ch => {
                    const id = ch.getAttribute('id');
                    const displayName = ch.querySelector('display-name')?.textContent || id;
                    const icon = ch.querySelector('icon')?.getAttribute('src') || '';
                    channels.set(id, { id, displayName, icon });
                });

                // Parse programmes
                const programmes = [];
                xmlDoc.querySelectorAll('programme').forEach(prog => {
                    const channelId = prog.getAttribute('channel');
                    const start = this.parseXMLTVTime(prog.getAttribute('start'));
                    const stop = this.parseXMLTVTime(prog.getAttribute('stop'));
                    const title = prog.querySelector('title')?.textContent || 'Unknown';
                    const desc = prog.querySelector('desc')?.textContent || '';
                    const category = prog.querySelector('category')?.textContent || '';

                    programmes.push({
                        channelId,
                        start,
                        stop,
                        title,
                        desc,
                        category
                    });
                });

                return { channels, programmes };
            }

            /**
             * Parse XMLTV time format (YYYYMMDDHHmmss +ZZZZ) to Date object
             * FIXED: Correctly handles timezone conversion
             * @param {string} xmltvTime - Time string in XMLTV format (e.g., "20251004103000 +0900")
             * @returns {Date} JavaScript Date object in local timezone
             */
            static parseXMLTVTime(xmltvTime) {
                if (!xmltvTime) return null;

                // Format: 20251004190000 +0900
                const match = xmltvTime.match(/(\d{4})(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})\s*([+-]\d{4})?/);
                if (!match) return null;

                const [, year, month, day, hour, minute, second, tz] = match;

                if (tz) {
                    // Convert timezone offset from "+0900" to "+09:00" format
                    const tzFormatted = tz.slice(0, 3) + ':' + tz.slice(3);
                    // Create ISO 8601 string with timezone: "2025-10-04T10:30:00+09:00"
                    const isoString = `${year}-${month}-${day}T${hour}:${minute}:${second}${tzFormatted}`;
                    // Browser automatically converts to local timezone
                    return new Date(isoString);
                }

                // No timezone info, assume local time
                const isoString = `${year}-${month}-${day}T${hour}:${minute}:${second}`;
                return new Date(isoString);
            }

            /**
             * Convert Date object to XMLTV time format
             * @param {Date} date - JavaScript Date object
             * @param {string} timezone - Timezone offset (e.g., '+0900')
             * @returns {string} XMLTV format time string
             */
            static formatXMLTVTime(date, timezone = '+0900') {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const hour = String(date.getHours()).padStart(2, '0');
                const minute = String(date.getMinutes()).padStart(2, '0');
                const second = String(date.getSeconds()).padStart(2, '0');

                return `${year}${month}${day}${hour}${minute}${second} ${timezone}`;
            }
        }

        // ===== CHANNEL ID MAPPING (Phase 2.5: Live XMLTV Integration) =====

        /**
         * Channel ID mapping for XMLTV data
         * Maps project channel names to EPGSHARE01 XMLTV channel IDs
         */
        const CHANNEL_ID_MAPPING = {
            // Major Broadcasters (Confirmed)
            "KBS2": "KBS2.kr",
            "MBC": "MBC.ON.kr",
            "tvN": "tvN.STORY.kr",
            "JTBC": "JTBC4.kr",
            "YTN": "YTN.kr",
            "OCN": "OCN.kr",

            // Specialized Channels (Confirmed)
            "중화TV": "중화TV.kr",
            "KBS Drama": "KBS.Drama.kr",
            "KBS Kids": "KBS.Kids.kr",
            "KBS Joy": "KBS.Joy.kr",
            "ENA": "ENA.kr",
            "MBC드라마": "MBC드라마.kr",

            // To be verified (fallback to best guess)
            "KBS1": "KBS1.kr",
            "SBS": "SBS.kr",
            "EBS1": "EBS1.kr",
            "EBS2": "EBS2.kr",

            // Multiple possible IDs (try first match)
            "OCN Movies": "OCN.Movies.kr",
            "OCN Movies2": "OCN.Movies2.kr",
            "JTBC Golf": "JTBC.Golf.kr",
            "SBS Golf": "SBS.Golf.kr",
            "SBS Golf2": "SBS.Golf2.kr",
            "tvN Sports": "tvN.Sports.kr",
            "KBSNSPORTS": "KBS.N.Sports.kr",
            "MBC SPORTS": "MBC.SPORTS+.kr",
            "MNet": "Mnet.kr"
        };

        /**
         * EPG Data Manager with LocalStorage caching and live XMLTV fetching
         */
        class EPGDataManager {
            static CACHE_KEY = 'kr_livetv_epg_cache';
            static CACHE_KEY_LIVE = 'kr_livetv_epg_cache_live';
            static CACHE_DURATION = 24 * 60 * 60 * 1000; // 24 hours in milliseconds

            // Phase 2.5: Live XMLTV Configuration
            static XMLTV_URL = 'https://epgshare01.online/epgshare01/epg_ripper_KR1.xml.gz';
            static CORS_PROXY = 'https://corsproxy.io/?';
            static USE_LIVE_EPG = true; // Toggle for live EPG

            /**
             * Get EPG data from cache or static fallback
             * @returns {Object} EPG data object
             */
            static getData() {
                // Try to load from cache first
                const cached = this.loadFromCache();
                if (cached) {
                    console.log('✅ Loaded EPG from cache');
                    return cached.data;
                }

                // Fallback to static data
                console.log('📊 Using static EPG data');
                const staticData = this.getStaticData();
                this.saveToCache(staticData);
                return staticData;
            }

            /**
             * Initialize EPG data - try live XMLTV first, fallback to cache/static
             * @returns {Promise<Object>} EPG data object
             */
            static async initializeEPG() {
                if (!this.USE_LIVE_EPG) {
                    return this.getData();
                }

                try {
                    console.log('🌐 Attempting to fetch live EPG data...');
                    const liveData = await this.fetchLiveXMLTV();
                    console.log('✅ Live EPG data loaded successfully');
                    return liveData;
                } catch (error) {
                    console.warn('⚠️ Live EPG fetch failed, using fallback:', error.message);
                    return this.getData();
                }
            }

            /**
             * Load EPG data from LocalStorage cache
             * Prioritizes live XMLTV cache over static cache
             * @returns {Object|null} Cached data or null if expired/missing
             */
            static loadFromCache() {
                // Try live cache first (EPGSHARE01)
                try {
                    const liveCached = localStorage.getItem(this.CACHE_KEY_LIVE);
                    if (liveCached) {
                        const { data, timestamp } = JSON.parse(liveCached);
                        const age = Date.now() - timestamp;

                        if (age < this.CACHE_DURATION) {
                            console.log(`✅ Loaded live EPG from cache (${(age / 1000 / 60).toFixed(0)}min old)`);
                            return { data, age };
                        } else {
                            console.log('⏰ Live EPG cache expired');
                            localStorage.removeItem(this.CACHE_KEY_LIVE);
                        }
                    }
                } catch (error) {
                    console.error('Error loading live EPG cache:', error);
                }

                // Fallback to static cache
                try {
                    const cached = localStorage.getItem(this.CACHE_KEY);
                    if (!cached) return null;

                    const { data, timestamp } = JSON.parse(cached);
                    const age = Date.now() - timestamp;

                    if (age < this.CACHE_DURATION) {
                        console.log(`📊 Loaded static EPG from cache (${(age / 1000 / 60).toFixed(0)}min old)`);
                        return { data, age };
                    } else {
                        console.log('⏰ Static EPG cache expired');
                        this.clearCache();
                        return null;
                    }
                } catch (error) {
                    console.error('Error loading static EPG cache:', error);
                    return null;
                }
            }

            /**
             * Save EPG data to LocalStorage cache with quota handling
             * @param {Object} data - EPG data to cache
             * @param {string} cacheKey - Cache key to use (optional)
             */
            static saveToCache(data, cacheKey = this.CACHE_KEY) {
                try {
                    const cacheObject = {
                        data,
                        timestamp: Date.now()
                    };
                    const jsonString = JSON.stringify(cacheObject);
                    const sizeKB = (jsonString.length / 1024).toFixed(2);

                    localStorage.setItem(cacheKey, jsonString);
                    console.log(`💾 EPG cached successfully (${sizeKB} KB)`);
                } catch (error) {
                    if (error.name === 'QuotaExceededError') {
                        console.warn('⚠️ LocalStorage quota exceeded, clearing old cache...');

                        // Clear all EPG caches to free up space
                        localStorage.removeItem(this.CACHE_KEY);
                        localStorage.removeItem(this.CACHE_KEY_LIVE);

                        // Try saving again with smaller dataset (only current channel data)
                        try {
                            const reducedData = this.reduceDataSize(data);
                            const reducedJson = JSON.stringify({ data: reducedData, timestamp: Date.now() });
                            localStorage.setItem(cacheKey, reducedJson);
                            console.log(`💾 Saved reduced EPG cache (${(reducedJson.length / 1024).toFixed(2)} KB)`);
                        } catch (retryError) {
                            console.warn('❌ Unable to cache EPG data, will use live data only');
                        }
                    } else {
                        console.error('Error saving EPG cache:', error);
                    }
                }
            }

            /**
             * Reduce EPG data size by keeping only essential fields
             * @param {Object} data - Full EPG data
             * @returns {Object} Reduced EPG data
             */
            static reduceDataSize(data) {
                const reduced = {};
                for (const [channel, programs] of Object.entries(data)) {
                    // Only keep first 5 programs per channel
                    reduced[channel] = programs.slice(0, 5).map(prog => ({
                        start: prog.start,
                        stop: prog.stop,
                        title: prog.title,
                        // Remove desc and category to save space
                    }));
                }
                return reduced;
            }

            /**
             * Clear EPG cache from LocalStorage
             */
            static clearCache() {
                localStorage.removeItem(this.CACHE_KEY);
            }

            /**
             * Decompress gzipped data using pako.js
             * @param {ArrayBuffer} gzipData - Gzipped data
             * @returns {string} Decompressed XML string
             */
            static decompressGzip(gzipData) {
                try {
                    const uint8Array = new Uint8Array(gzipData);
                    const decompressed = pako.inflate(uint8Array, { to: 'string' });
                    return decompressed;
                } catch (error) {
                    console.error('Gzip decompression failed:', error);
                    throw new Error('Failed to decompress XMLTV data');
                }
            }

            /**
             * Fetch live XMLTV data from EPGSHARE01
             * @returns {Promise<Object>} Parsed EPG data
             */
            static async fetchLiveXMLTV() {
                try {
                    // 1. Construct proxied URL
                    const proxiedURL = this.CORS_PROXY + encodeURIComponent(this.XMLTV_URL);
                    console.log('📡 Fetching XMLTV from:', this.XMLTV_URL);

                    // 2. Fetch gzipped XMLTV file
                    const response = await fetch(proxiedURL);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    // 3. Get ArrayBuffer for gzip decompression
                    const arrayBuffer = await response.arrayBuffer();
                    console.log(`📦 Downloaded ${(arrayBuffer.byteLength / 1024).toFixed(2)} KB (gzipped)`);

                    // 4. Decompress gzip
                    const xmlText = this.decompressGzip(arrayBuffer);
                    console.log(`📄 Decompressed to ${(xmlText.length / 1024).toFixed(2)} KB (XML)`);

                    // 5. Parse XMLTV
                    const parsed = XMLTVParser.parse(xmlText);
                    console.log(`📺 Found ${parsed.channels.size} channels, ${parsed.programmes.length} programmes`);

                    // 6. Convert to our format with channel mapping (filtered for 24h window)
                    const epgData = this.convertParsedToEPGDataWithMapping(parsed);

                    // 7. Save to cache (with quota handling)
                    this.saveToCache(epgData, this.CACHE_KEY_LIVE);

                    return epgData;
                } catch (error) {
                    console.error('❌ Live XMLTV fetch failed:', error);
                    throw error;
                }
            }

            /**
             * Fetch EPG data from XMLTV source (legacy method)
             * @param {string} url - XMLTV data URL
             * @returns {Promise<Object>} Parsed EPG data
             */
            static async fetchXMLTV(url) {
                try {
                    const response = await fetch(url);
                    const xmlText = await response.text();
                    const parsed = XMLTVParser.parse(xmlText);

                    // Convert to our data format
                    const epgData = this.convertParsedToEPGData(parsed);
                    this.saveToCache(epgData);
                    return epgData;
                } catch (error) {
                    console.error('Error fetching XMLTV:', error);
                    throw error;
                }
            }

            /**
             * Convert parsed XMLTV data to our EPG data format
             * @param {Object} parsed - Parsed XMLTV data
             * @returns {Object} EPG data in our format
             */
            static convertParsedToEPGData(parsed) {
                const epgData = {};

                parsed.programmes.forEach(prog => {
                    const channel = parsed.channels.get(prog.channelId);
                    if (!channel) return;

                    const channelName = channel.displayName;
                    if (!epgData[channelName]) {
                        epgData[channelName] = [];
                    }

                    epgData[channelName].push({
                        start: prog.start,
                        stop: prog.stop,
                        title: prog.title,
                        desc: prog.desc,
                        category: prog.category
                    });
                });

                return epgData;
            }

            /**
             * Filter programmes to only include current + next 24 hours
             * @param {Date} programStart - Program start time
             * @param {Date} programStop - Program stop time
             * @returns {boolean} True if program is within time window
             */
            static isProgramRelevant(programStart, programStop) {
                const now = new Date();
                const windowStart = new Date(now.getTime() - 2 * 60 * 60 * 1000); // 2 hours ago
                const windowEnd = new Date(now.getTime() + 26 * 60 * 60 * 1000);   // 26 hours ahead

                return programStop >= windowStart && programStart <= windowEnd;
            }

            /**
             * Convert parsed XMLTV data to our EPG format using channel ID mapping
             * Optimized: Only stores current + next 24 hours to reduce LocalStorage usage
             * @param {Object} parsed - Parsed XMLTV data
             * @returns {Object} EPG data in our format with mapped channel names
             */
            static convertParsedToEPGDataWithMapping(parsed) {
                const epgData = {};
                const unmappedChannels = new Set();
                let totalPrograms = 0;
                let filteredPrograms = 0;

                // Create reverse mapping: XMLTV ID → Project Channel Name
                const reverseMapping = {};
                for (const [projectName, xmltvId] of Object.entries(CHANNEL_ID_MAPPING)) {
                    reverseMapping[xmltvId] = projectName;
                }

                parsed.programmes.forEach(prog => {
                    totalPrograms++;

                    // Filter: Only include programs within time window (current + next 24h)
                    if (!this.isProgramRelevant(prog.start, prog.stop)) {
                        return; // Skip programs outside time window
                    }
                    filteredPrograms++;

                    const channel = parsed.channels.get(prog.channelId);
                    if (!channel) return;

                    // Try to find mapped project channel name
                    let projectChannelName = reverseMapping[prog.channelId];

                    // If not found in mapping, use display name as fallback
                    if (!projectChannelName) {
                        projectChannelName = channel.displayName;
                        unmappedChannels.add(`${channel.displayName} (${prog.channelId})`);
                    }

                    if (!epgData[projectChannelName]) {
                        epgData[projectChannelName] = [];
                    }

                    epgData[projectChannelName].push({
                        start: prog.start,
                        stop: prog.stop,
                        title: prog.title,
                        desc: prog.desc || '',
                        category: prog.category || ''
                    });
                });

                // Log unmapped channels for manual review
                if (unmappedChannels.size > 0) {
                    console.log('📋 Unmapped channels:', Array.from(unmappedChannels).slice(0, 10));
                }

                console.log(`✅ Mapped EPG data for ${Object.keys(epgData).length} channels`);
                console.log(`📊 Filtered ${filteredPrograms} / ${totalPrograms} programs (24h window)`);
                return epgData;
            }

            /**
             * Get extended static EPG data with full day schedule
             * @returns {Object} Extended EPG data
             */
            static getStaticData() {
                return {
                    "KBS1": [
                        { start: "06:00", stop: "07:00", title: "아침뉴스타임", desc: "새벽 속보와 날씨 정보" },
                        { start: "07:00", stop: "08:30", title: "아침마당", desc: "시청자와 함께하는 생활정보 프로그램" },
                        { start: "08:30", stop: "09:00", title: "아침 드라마", desc: "따뜻한 가족 이야기" },
                        { start: "12:00", stop: "12:45", title: "KBS 뉴스 12", desc: "점심시간 주요 뉴스" },
                        { start: "19:00", stop: "20:00", title: "KBS 뉴스 9", desc: "오늘의 주요 뉴스와 심층 분석" },
                        { start: "20:00", stop: "21:00", title: "일일연속극", desc: "가족드라마 - 일상 속 따뜻한 이야기" },
                        { start: "21:00", stop: "22:00", title: "시사토론", desc: "주요 이슈 심층 토론" }
                    ],
                    "KBS2": [
                        { start: "07:30", stop: "09:00", title: "굿모닝 대한민국", desc: "아침을 여는 종합 정보 프로그램" },
                        { start: "12:00", stop: "13:30", title: "생생정보", desc: "알짜 생활정보 가득" },
                        { start: "18:00", stop: "19:00", title: "연예가중계", desc: "연예계 소식과 스타 인터뷰" },
                        { start: "19:00", stop: "20:00", title: "개그콘서트", desc: "주말을 웃음으로 가득 채우는 코미디 쇼" },
                        { start: "20:00", stop: "22:00", title: "주말드라마", desc: "감동과 재미를 선사하는 프라임 드라마" }
                    ],
                    "MBC": [
                        { start: "06:30", stop: "08:00", title: "뉴스투데이", desc: "아침 종합 뉴스" },
                        { start: "08:00", stop: "09:00", title: "기분 좋은 날", desc: "건강과 힐링 토크쇼" },
                        { start: "12:00", stop: "13:20", title: "뉴스데스크", desc: "점심시간 뉴스" },
                        { start: "19:00", stop: "20:00", title: "MBC 뉴스데스크", desc: "종합 뉴스 프로그램" },
                        { start: "20:00", stop: "21:30", title: "나 혼자 산다", desc: "1인 가구의 리얼 라이프 버라이어티" },
                        { start: "21:30", stop: "23:00", title: "황금어장", desc: "라디오스타 - 토크의 향연" }
                    ],
                    "SBS": [
                        { start: "06:00", stop: "08:00", title: "모닝와이드", desc: "아침 종합 정보 프로그램" },
                        { start: "12:00", stop: "12:40", title: "SBS 뉴스", desc: "점심 뉴스" },
                        { start: "18:50", stop: "19:55", title: "SBS 뉴스", desc: "저녁 종합 뉴스" },
                        { start: "19:55", stop: "21:00", title: "런닝맨", desc: "최고의 예능 버라이어티" },
                        { start: "21:00", stop: "22:30", title: "미운 우리 새끼", desc: "가족 관찰 예능" },
                        { start: "22:30", stop: "00:00", title: "주말 드라마", desc: "프라임타임 드라마" }
                    ],
                    "tvN": [
                        { start: "07:30", stop: "09:00", title: "Live Info Show", desc: "아침 정보 프로그램" },
                        { start: "19:00", stop: "20:30", title: "삼시세끼", desc: "자급자족 농촌 라이프" },
                        { start: "20:30", stop: "22:00", title: "유 퀴즈 온 더 블럭", desc: "유재석의 거리 토크쇼" },
                        { start: "22:00", stop: "23:30", title: "tvN 드라마", desc: "프리미엄 드라마 시리즈" }
                    ],
                    "JTBC": [
                        { start: "08:00", stop: "10:00", title: "아침&", desc: "아침 뉴스 프로그램" },
                        { start: "19:00", stop: "20:00", title: "JTBC 뉴스룸", desc: "손석희의 뉴스 브리핑" },
                        { start: "20:00", stop: "21:30", title: "비정상회담", desc: "글로벌 토크쇼" },
                        { start: "21:30", stop: "23:00", title: "아는형님", desc: "전학생 토크 예능" }
                    ],
                    "YTN": [
                        { start: "00:00", stop: "06:00", title: "YTN 뉴스", desc: "24시간 실시간 뉴스" },
                        { start: "06:00", stop: "09:00", title: "뉴스N이슈", desc: "아침 뉴스 심층 분석" },
                        { start: "12:00", stop: "13:00", title: "뉴스와이드", desc: "점심 종합 뉴스" },
                        { start: "19:00", stop: "20:00", title: "뉴스 나이트", desc: "저녁 주요 뉴스" }
                    ],
                    "MNet": [
                        { start: "18:00", stop: "19:30", title: "엠카운트다운", desc: "K-POP 음악 차트쇼" },
                        { start: "20:00", stop: "22:00", title: "I-LAND", desc: "아이돌 서바이벌 오디션" },
                        { start: "22:00", stop: "23:30", title: "Show Me The Money", desc: "힙합 오디션 프로그램" }
                    ],
                    "OCN": [
                        { start: "19:00", stop: "21:00", title: "범죄의 재구성", desc: "실화 범죄 다큐멘터리" },
                        { start: "21:00", stop: "23:00", title: "스릴러 영화", desc: "긴장감 넘치는 액션 스릴러" },
                        { start: "23:00", stop: "01:00", title: "미스터리 드라마", desc: "추리와 서스펜스" }
                    ]
                };
            }
        }

        /**
         * EPG Time Matcher
         * Finds current and next programs based on current time
         */
        class EPGTimeMatcher {
            /**
             * Parse time string to minutes since midnight (Beijing timezone)
             * @param {string} timeStr - Time in format "HH:MM" or Date object
             * @returns {number} Minutes since midnight in Beijing time
             */
            static parseTime(timeStr) {
                if (timeStr instanceof Date) {
                    // Convert Date object to Beijing time
                    const beijingHour = parseInt(timeStr.toLocaleString('zh-CN', {
                        timeZone: 'Asia/Shanghai',
                        hour: '2-digit',
                        hour12: false
                    }));
                    const beijingMinute = parseInt(timeStr.toLocaleString('zh-CN', {
                        timeZone: 'Asia/Shanghai',
                        minute: '2-digit'
                    }));
                    return beijingHour * 60 + beijingMinute;
                }
                const [hours, minutes] = timeStr.split(':').map(Number);
                return hours * 60 + minutes;
            }

            /**
             * Format minutes to HH:MM string
             * @param {number} minutes - Minutes since midnight
             * @returns {string} Time in HH:MM format
             */
            static formatTime(minutes) {
                const hours = Math.floor(minutes / 60);
                const mins = minutes % 60;
                return `${String(hours).padStart(2, '0')}:${String(mins).padStart(2, '0')}`;
            }

            /**
             * Get current and next programs for a channel (using Beijing timezone)
             * @param {Array} channelPrograms - Array of program objects
             * @param {Date} currentTime - Current time (optional, defaults to now)
             * @returns {Object} { now: program, next: program }
             */
            static getCurrentAndNext(channelPrograms, currentTime = new Date()) {
                if (!channelPrograms || channelPrograms.length === 0) {
                    return { now: null, next: null };
                }

                // Get current Beijing time in minutes since midnight
                const beijingHour = parseInt(currentTime.toLocaleString('zh-CN', {
                    timeZone: 'Asia/Shanghai',
                    hour: '2-digit',
                    hour12: false
                }));
                const beijingMinute = parseInt(currentTime.toLocaleString('zh-CN', {
                    timeZone: 'Asia/Shanghai',
                    minute: '2-digit'
                }));
                const nowMinutes = beijingHour * 60 + beijingMinute;

                // Sort programs by start time
                const sortedPrograms = [...channelPrograms].sort((a, b) => {
                    const aStart = this.parseTime(a.start);
                    const bStart = this.parseTime(b.start);
                    return aStart - bStart;
                });

                // Find current program
                let currentProgram = null;
                let nextProgram = null;

                for (let i = 0; i < sortedPrograms.length; i++) {
                    const program = sortedPrograms[i];
                    const startMinutes = this.parseTime(program.start);
                    const stopMinutes = this.parseTime(program.stop);

                    // Handle programs that cross midnight
                    const adjustedStop = stopMinutes < startMinutes ? stopMinutes + 24 * 60 : stopMinutes;
                    const adjustedNow = nowMinutes < startMinutes && stopMinutes < startMinutes ? nowMinutes + 24 * 60 : nowMinutes;

                    // Check if current time is within program time
                    if (adjustedNow >= startMinutes && adjustedNow < adjustedStop) {
                        currentProgram = program;
                        nextProgram = sortedPrograms[i + 1] || sortedPrograms[0]; // Loop to first if at end
                        break;
                    }

                    // If we passed the current time, this is the next program
                    if (startMinutes > nowMinutes && !nextProgram) {
                        nextProgram = program;
                    }
                }

                // If no current program found, use last program as current and first as next
                if (!currentProgram && sortedPrograms.length > 0) {
                    currentProgram = sortedPrograms[sortedPrograms.length - 1];
                    nextProgram = sortedPrograms[0];
                }

                return { now: currentProgram, next: nextProgram };
            }

            /**
             * Format program time range for display in Beijing time (UTC+8)
             * @param {Object} program - Program object with start/stop
             * @returns {string} Formatted time range "HH:MM-HH:MM (北京时间)"
             */
            static formatProgramTime(program) {
                if (!program) return '';

                if (program.start instanceof Date && program.stop instanceof Date) {
                    // Convert to Beijing time (Asia/Shanghai = UTC+8)
                    const startBeijing = program.start.toLocaleString('zh-CN', {
                        timeZone: 'Asia/Shanghai',
                        hour: '2-digit',
                        minute: '2-digit',
                        hour12: false
                    });
                    const stopBeijing = program.stop.toLocaleString('zh-CN', {
                        timeZone: 'Asia/Shanghai',
                        hour: '2-digit',
                        minute: '2-digit',
                        hour12: false
                    });
                    return `${startBeijing}-${stopBeijing}`;
                }

                return `${program.start}-${program.stop}`;
            }
        }

        // Initialize EPG data (will be populated asynchronously)
        let epgDataSource = EPGDataManager.getData(); // Sync fallback

        // Asynchronously load live EPG data (Phase 2.5)
        (async function initializeEPGData() {
            try {
                epgDataSource = await EPGDataManager.initializeEPG();
                console.log('🎉 EPG data initialized with', Object.keys(epgDataSource).length, 'channels');
            } catch (error) {
                console.error('EPG initialization error:', error);
            }
        })();

        // ===== CORE FUNCTIONS =====

        /**
         * Play a channel stream
         * @param {string} url - M3U8 stream URL
         * @param {string} channelName - Name of the channel
         * @param {HTMLElement} targetBtn - Button element that was clicked
         */
        function playChannel(url, channelName, targetBtn) {
            // Show loading indicator
            loadingIndicator.classList.add('active');

            try {
                // Update current channel info
                currentChannel = channelName;
                currentChannelDisplay.textContent = `Now Playing: ${channelName}`;

                // Check if HLS.js is supported
                if (Hls.isSupported()) {
                    // Destroy previous HLS instance if exists
                    if (hls) {
                        hls.destroy();
                    }

                    // Create new HLS instance with optimized configuration
                    hls = new Hls({
                        enableWorker: true,
                        lowLatencyMode: true,
                        backBufferLength: 90
                    });

                    hls.loadSource(url);
                    hls.attachMedia(video);

                    // Handle manifest parsed event
                    hls.on(Hls.Events.MANIFEST_PARSED, function () {
                        video.play().catch(err => {
                            showError('播放失败 / Playback failed: ' + err.message);
                        });
                        loadingIndicator.classList.remove('active');
                    });

                    // Handle errors
                    hls.on(Hls.Events.ERROR, function (event, data) {
                        if (data.fatal) {
                            loadingIndicator.classList.remove('active');
                            showError(`流媒体错误 / Stream error: ${data.type}`);
                        }
                    });

                } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                    // Native HLS support (Safari, iOS)
                    video.src = url;
                    video.addEventListener('loadedmetadata', function () {
                        video.play().catch(err => {
                            showError('播放失败 / Playback failed: ' + err.message);
                        });
                        loadingIndicator.classList.remove('active');
                    });
                } else {
                    showError('您的浏览器不支持HLS播放 / Your browser does not support HLS playback');
                    loadingIndicator.classList.remove('active');
                }

                // Update UI - highlight playing channel
                document.querySelectorAll('.channel-btn').forEach(btn => {
                    btn.classList.remove('playing');
                });
                targetBtn.classList.add('playing');

            } catch (error) {
                loadingIndicator.classList.remove('active');
                showError('播放失败 / Playback failed: ' + error.message);
            }
        }

        /**
         * Show error message to user
         * @param {string} message - Error message to display
         */
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.add('show');
            setTimeout(() => {
                errorMessage.classList.remove('show');
            }, 5000);
        }

        /**
         * Create EPG tooltip HTML for a channel (Phase 2: Time-matched)
         * @param {string} channelName - Name of the channel
         * @returns {string} HTML string for EPG tooltip
         */
        function createEPGTooltip(channelName) {
            const programs = epgDataSource[channelName];

            if (!programs || programs.length === 0) {
                return `
                    <div class="epg-tooltip">
                        <h4>${channelName}</h4>
                        <div class="epg-no-data">📺 节目信息暂无 / No program data available</div>
                    </div>
                `;
            }

            // Get current and next programs based on real time
            const { now, next } = EPGTimeMatcher.getCurrentAndNext(programs);

            let programsHTML = '';

            if (now) {
                const timeRange = EPGTimeMatcher.formatProgramTime(now);
                programsHTML += `
                    <div class="epg-program">
                        <div class="epg-time">${timeRange}<span class="epg-badge">NOW</span></div>
                        <div class="epg-title">${now.title}</div>
                        <div class="epg-desc">${now.desc}</div>
                    </div>
                `;
            }

            if (next) {
                const timeRange = EPGTimeMatcher.formatProgramTime(next);
                programsHTML += `
                    <div class="epg-program">
                        <div class="epg-time">${timeRange}<span class="epg-badge">NEXT</span></div>
                        <div class="epg-title">${next.title}</div>
                        <div class="epg-desc">${next.desc}</div>
                    </div>
                `;
            }

            if (!programsHTML) {
                programsHTML = '<div class="epg-no-data">📺 当前时段无节目信息 / No programs scheduled</div>';
            }

            return `
                <div class="epg-tooltip">
                    <h4>${channelName}</h4>
                    ${programsHTML}
                </div>
            `;
        }

        /**
         * Render channel buttons using DocumentFragment for better performance
         */
        function renderChannels() {
            const fragment = document.createDocumentFragment();

            channels.forEach(channel => {
                const btn = document.createElement('button');
                btn.className = 'channel-btn';
                btn.dataset.category = channel.category;
                btn.dataset.name = channel.name.toLowerCase();
                btn.setAttribute('aria-label', `Play ${channel.name}`);

                // Add channel name and EPG tooltip
                btn.innerHTML = `
                    ${channel.name}
                    ${createEPGTooltip(channel.name)}
                `;

                btn.addEventListener('click', () => {
                    playChannel(channel.url, channel.name, btn);
                });

                fragment.appendChild(btn);
            });

            channelGrid.appendChild(fragment);
        }

        /**
         * Filter channels based on search query
         * @param {string} query - Search query string
         */
        function filterChannels(query) {
            const searchTerm = query.toLowerCase().trim();
            const channelBtns = document.querySelectorAll('.channel-btn');

            channelBtns.forEach(btn => {
                const channelName = btn.dataset.name;
                if (channelName.includes(searchTerm)) {
                    btn.classList.remove('hidden');
                } else {
                    btn.classList.add('hidden');
                }
            });
        }

        /**
         * Filter channels by category
         * @param {string} category - Category to filter
         */
        function filterByCategory(category) {
            const channelBtns = document.querySelectorAll('.channel-btn');

            channelBtns.forEach(btn => {
                if (category === 'all' || btn.dataset.category === category) {
                    btn.classList.remove('hidden');
                } else {
                    btn.classList.add('hidden');
                }
            });

            // Clear search input
            searchInput.value = '';
        }

        // ===== EVENT LISTENERS =====

        // Search functionality
        searchInput.addEventListener('input', (e) => {
            filterChannels(e.target.value);
        });

        // Category filter buttons
        categoryBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                // Update active button
                categoryBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');

                // Filter channels
                filterByCategory(btn.dataset.category);
            });
        });

        // Keyboard navigation support
        document.addEventListener('keydown', (e) => {
            if (e.key === '/' || (e.ctrlKey && e.key === 'f')) {
                e.preventDefault();
                searchInput.focus();
            }
        });

        // ===== INITIALIZATION =====

        // Render all channels on page load
        renderChannels();

        // Log initialization
        console.log(`✅ Player initialized with ${channels.length} channels`);
    </script>
</body>
</html>
